{% extends "base.html" %}

{% block title %}
Tasks
{% endblock %}

{% block body %}



<!-- Изменяем блок с активными задачами -->
<h2>Active Tasks</h2>
<div class="list-group">
    {% for task in active_tasks %}
    <div class="list-group-item d-flex align-items-center">
        <div class="form-check me-3">
            <input class="form-check-input" type="checkbox"
                   data-task-id="{{ task._id }}"
                   {% if task.completed %}checked{% endif %}>
        </div>
        <a href="#" class="flex-grow-1 task-item" data-task-id="{{ task._id }}">
            {{ task.title }}
        </a>
        <button class="btn btn-danger btn-sm ms-2"
                data-task-id="{{ task._id }}">
            <i class="bi bi-trash"></i>
        </button>
    </div>
    {% endfor %}
</div>

<!-- Изменяем блок с выполненными задачами -->
<h2 class="mt-4">Completed Tasks</h2>
<div class="list-group">
    {% for task in completed_tasks %}
    <div class="list-group-item d-flex align-items-center">
        <div class="form-check me-3">
            <input class="form-check-input" type="checkbox"
                   data-task-id="{{ task._id }}"
                   {% if task.completed %}checked{% endif %}>
        </div>
        <a href="#" class="flex-grow-1 task-item text-muted text-decoration-line-through"
           data-task-id="{{ task._id }}">
            {{ task.title }}
        </a>
        <button class="btn btn-danger btn-sm ms-2"
                data-task-id="{{ task._id }}">
            <i class="bi bi-trash"></i>
        </button>
    </div>
    {% endfor %}
</div>


<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
    Add Task
</button>


<!-- Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/tasks">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="taskModalLabel">Add New Task</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Title*</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Deadline*</label>
                        <div class="input-group">
                            <input type="datetime-local" class="form-control" name="deadline" required>
                            <span class="input-group-text">
                <i class="bi bi-calendar"></i>
              </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reminders</label>
                        <div id="remindersContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addReminder()">
                            Add Reminder
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    function addReminder() {
      const container = document.getElementById('remindersContainer');
      const reminderDiv = document.createElement('div');
      reminderDiv.className = 'input-group mb-2';
      reminderDiv.innerHTML = `
        <input type="datetime-local" class="form-control" name="reminders">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
          <i class="bi bi-trash"></i>
        </button>
      `;
      container.appendChild(reminderDiv);
    }
</script>


<!-- Добавляем модальное окно для редактирования -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editTaskForm">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="editTaskModalLabel">Edit Task</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label class="form-label">Task Title*</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Deadline*</label>
                        <div class="input-group">
                            <input type="datetime-local" class="form-control" id="editDeadline" name="deadline"
                                   required>
                            <span class="input-group-text">
                                <i class="bi bi-calendar"></i>
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reminders</label>
                        <div id="editRemindersContainer"></div>
                        <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addEditReminder()">
                            Add Reminder
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Добавляем обработчики для задач
    document.querySelectorAll('.task-item').forEach(item => {
        item.addEventListener('click', async function(e) {
            e.preventDefault();
            const taskId = this.dataset.taskId;

            // Получаем данные задачи
            const response = await fetch(`/task/${taskId}`);
            const task = await response.json();

            // Заполняем форму
            document.getElementById('editTaskId').value = taskId;
            document.getElementById('editTitle').value = task.title;
            document.getElementById('editDescription').value = task.description;
            document.getElementById('editDeadline').value = task.deadline;

            // Заполняем reminders
            const container = document.getElementById('editRemindersContainer');
            container.innerHTML = '';
            task.reminders?.forEach(reminder => {
                addEditReminder(reminder);
            });

            // Показываем модальное окно
            new bootstrap.Modal(document.getElementById('editTaskModal')).show();
        });
    });

    // Обработчик отправки формы редактирования
    document.getElementById('editTaskForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const taskId = document.getElementById('editTaskId').value;
        const formData = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            deadline: document.getElementById('editDeadline').value,
            reminders: Array.from(document.querySelectorAll('#editRemindersContainer input')).map(input => input.value)
        };

        await fetch(`/task/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        window.location.reload();
    });

    // Функции для работы с reminders
    function addEditReminder(value = '') {
        const container = document.getElementById('editRemindersContainer');
        const reminderDiv = document.createElement('div');
        reminderDiv.className = 'input-group mb-2';
        reminderDiv.innerHTML = `
            <input type="datetime-local" class="form-control" name="reminders" value="${value}">
            <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        `;
        container.appendChild(reminderDiv);
    }
</script>


<script>
    // Обработчик для чекбоксов
document.querySelectorAll('.form-check-input').forEach(checkbox => {
    checkbox.addEventListener('change', async function() {
        const taskId = this.dataset.taskId;
        await fetch(`/task/${taskId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({completed: this.checked})
        });
        window.location.reload();
    });
});

// Обработчик для кнопок удаления
document.querySelectorAll('.btn-danger').forEach(button => {
    button.addEventListener('click', async function() {
        const taskId = this.dataset.taskId;
        if (confirm('Are you sure you want to delete this task?')) {
            await fetch(`/task/${taskId}`, {
                method: 'DELETE'
            });
            window.location.reload();
        }
    });
});
</script>


{% endblock %}


